name: user-service-prod
# test 2
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Tests
      run: npm test
      env:
        CI: true
        NODE_ENV: test
        # Mock DB URL for tests if needed, though our tests mock the DB calls
        MONGODB_URL: mongodb://localhost:27017/test-db 

  # Trigger deployment only if tests pass
  deploy:
    needs: test
    if: github.ref == 'refs/heads/master'  # Changed from 'main' to 'master'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deployment
        env:
          DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "ðŸš€ Triggering deployment to Render..."
          if [ -z "$DEPLOY_HOOK_URL" ]; then
            echo "âŒ Error: RENDER_DEPLOY_HOOK_URL secret is not set!"
            echo "Available secrets are not shown for security reasons."
            echo "Please verify the secret name is exactly: RENDER_DEPLOY_HOOK_URL"
            exit 1
          fi
          echo "Calling Render deploy hook..."
          curl -X POST "$DEPLOY_HOOK_URL"
          echo ""
          echo "âœ… Deployment webhook triggered successfully!"
          echo ""
          echo "â³ Render is now building and deploying your service..."
          echo "This typically takes 2-5 minutes."
      
      - name: Wait for Deployment to Complete
        env:
          SERVICE_URL: https://user-service-vv2a.onrender.com
        run: |
          echo "â³ Waiting for deployment to complete..."
          echo "Checking health endpoint: $SERVICE_URL/health"
          echo ""
          
          MAX_ATTEMPTS=60  # 60 attempts = 5 minutes (5 seconds between each)
          ATTEMPT=0
          SLEEP_TIME=5
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Try to hit the health endpoint
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo ""
              echo "âœ… Deployment successful! Service is live and healthy."
              echo "ðŸŒ Service URL: $SERVICE_URL"
              exit 0
            else
              echo "   Status: $HTTP_CODE (waiting...)"
              sleep $SLEEP_TIME
            fi
          done
          
          echo ""
          echo "âš ï¸ Deployment verification timed out after 5 minutes."
          echo "The service might still be deploying. Check Render dashboard."
          exit 1
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment webhook triggered successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ **Render is now building and deploying your service**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Service: user-service" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: Render" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered at: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitor deployment progress:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [Render Dashboard](https://dashboard.render.com)" >> $GITHUB_STEP_SUMMARY
          echo "2. Click on your \`user-service\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check the **Events** tab for real-time logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ Deployment typically takes 2-5 minutes to complete." >> $GITHUB_STEP_SUMMARY
